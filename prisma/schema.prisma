generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String                @id @default(uuid())
  email             String                @unique
  password          String?
  avatar            String?               @default("https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png")
  name              String
  role              Role
  status            UserStatus            @default(ACTIVE)
  googleId          String?               @unique
  isVerified        Boolean               @default(false)
  createAt          DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  admin             Admin?
  cashier           Cashier?
  customer          Customer?
  CustomerOrder     CustomerOrder[]
  activationToken   EmailActivationToken?
  manager           Manager?
  codes             MfaCode[]
  PasswordResetCode PasswordResetCode[]
}

model MfaCode {
  id        String   @id @default(uuid())
  userId    String
  code      String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailActivationToken {
  id        String   @id @default(uuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Customer {
  id        String   @id @default(uuid())
  userId    String   @unique
  points    Int      @default(0)
  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Manager {
  id         String   @id @default(uuid())
  userId     String   @unique
  department String
  createAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique
  permissions String
  createAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Cashier {
  id        String          @id @default(uuid())
  userId    String          @unique
  register  String?
  createAt  DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    CustomerOrder[]
}

model Supplier {
  id        String             @id @default(uuid())
  name      String
  email     String             @unique
  rating    Decimal            @default(1)
  active    Boolean            @default(true)
  phone     String?
  avatar    String             @default("https://img.freepik.com/premium-vector/supplier-icon-vector-image-can-be-used-supply-chain_120816-403225.jpg")
  createAt  DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  orders    SupplierOrder[]
  products  SupplierProducts[]
}

model Product {
  id               String             @id @default(uuid())
  name             String
  count            Decimal            @default(0)
  type             ProductType
  image            String?
  createAt         DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  mealProducts     Ingredient[]
  supplierProducts SupplierProducts[]

  @@index([type, count, name])
}

model SupplierProducts {
  id          String              @id @default(uuid())
  supplierId  String
  productId   String?
  quantity    Decimal             @default(0)
  price       Decimal
  priceForOne Decimal             @default(0)
  name        String              @default("Need to add name")
  limit       Decimal             @default(1000)
  createAt    DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  orderItems  SupplierOrderItem[]
  product     Product?            @relation(fields: [productId], references: [id])
  supplier    Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([productId, supplierId])
}

model SupplierOrder {
  id         String              @id @default(uuid())
  supplierId String
  totalPrice Decimal             @default(0)
  status     OrderStatus         @default(INITIAL)
  createAt   DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  supplier   Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  orderItems SupplierOrderItem[]

  @@index([status, supplierId])
}

model SupplierOrderItem {
  id                String           @id @default(uuid())
  supplierOrderId   String
  supplierProductId String
  quantity          Decimal          @default(1)
  price             Decimal
  createAt          DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  order             SupplierOrder    @relation(fields: [supplierOrderId], references: [id], onDelete: Cascade)
  supplierProduct   SupplierProducts @relation(fields: [supplierProductId], references: [id], onDelete: Cascade)
}

model Ingredient {
  id        String   @id @default(uuid())
  mealId    String
  productId String
  quantity  Decimal  @default(1)
  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  meal      Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([mealId, productId])
}

model MealCategory {
  id        String         @id @default(uuid())
  name      String
  slug      String         @unique
  parentId  String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  meals     Meal[]
  parent    MealCategory?  @relation("Subcategories", fields: [parentId], references: [id])
  children  MealCategory[] @relation("Subcategories")
}

model Location {
  id           String         @id @default(uuid())
  name         String
  address      String
  phone        String?
  avatar       String?
  slug         String         @unique
  wifiSsid     String?
  wifiPassword String?
  socialLinks  Json?
  openingHours Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  meals        LocationMeal[]
}

model LocationMeal {
  id         String   @id @default(uuid())
  locationId String
  mealId     String
  available  Boolean  @default(true)
  price      Decimal?
  stock      Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  meal       Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@unique([locationId, mealId])
}

model Meal {
  id                String              @id @default(uuid())
  name              String
  description       String?
  image             String?
  price             Decimal             @default(0)
  weight            Decimal?            @db.Decimal(10, 2)
  categoryId        String?
  createAt          DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  CustomerOrderItem CustomerOrderItem[]
  ingredients       Ingredient[]
  locations         LocationMeal[]
  category          MealCategory?       @relation(fields: [categoryId], references: [id])
}

model CustomerOrder {
  id         String              @id @default(uuid())
  customerId String?
  cashierId  String?
  status     CustomerOrderStatus @default(INITIAL)
  totalPrice Decimal             @default(0)
  billId     String?
  createAt   DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  bill       Bill?               @relation(fields: [billId], references: [id])
  cashier    Cashier?            @relation(fields: [cashierId], references: [id])
  customer   User?               @relation(fields: [customerId], references: [id])
  items      CustomerOrderItem[]

  @@index([status, customerId])
}

model CustomerOrderItem {
  id        String        @id @default(uuid())
  orderId   String
  mealId    String
  quantity  Int           @default(1)
  price     Decimal
  createAt  DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  Bill      Bill?
  meal      Meal          @relation(fields: [mealId], references: [id], onDelete: Cascade)
  order     CustomerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, mealId])
  @@index([orderId, mealId])
}

model Bill {
  id            String            @id @default(uuid())
  orderId       String            @unique
  paid          Boolean           @default(false)
  method        PaymentMethod
  paidAt        DateTime?
  createAt      DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  order         CustomerOrderItem @relation(fields: [orderId], references: [id], onDelete: Cascade)
  CustomerOrder CustomerOrder[]
}

model FeedbackContact {
  id          String     @id @default(uuid())
  name        String?
  email       String?    @unique
  phoneE164   String     @unique
  phoneRegion String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  feedbacks   Feedback[]
}

model Feedback {
  id            String          @id @default(uuid())
  ratingFood    Int
  ratingService Int
  comment       String?
  visitorId     String          @db.VarChar(64)
  deviceHash    String          @db.VarChar(128)
  ipHash        String          @db.VarChar(64)
  uaHash        String          @db.VarChar(64)
  periodKey     String          @db.VarChar(20)
  status        FeedbackStatus  @default(UNTRIAGED)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  contactId     String
  contact       FeedbackContact @relation(fields: [contactId], references: [id])

  @@unique([visitorId, periodKey], map: "uniq_feedback_visitor_period")
  @@unique([deviceHash, periodKey], map: "uniq_feedback_device_period")
  @@index([ipHash, uaHash, createdAt], map: "idx_feedback_ipua_time")
}

enum PaymentMethod {
  CASH
  CARD
  TERMINAL
  ONLINE
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum Role {
  CUSTOMER
  MANAGER
  ADMIN
  CASHIER
}

enum ProductType {
  WEIGHT
  LIQUID
  QUANTITY
}

enum OrderStatus {
  INITIAL
  IN_PROGRESS
  DELIVERED
  CANCELLED
  FAILED
}

enum CustomerOrderStatus {
  INITIAL
  SUCCESS
  CANCELLED
  FAILED
}

enum FeedbackStatus {
  UNTRIAGED
  NEEDS_MORE_INFO
  IN_BACKLOG
  IN_PROGRESS
  RESOLVED
  REVIEWED
  WONT_FIX
  DUPLICATE
}
